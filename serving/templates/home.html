<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <title>Kite Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  
  <style>
    /* Remove number input arrows */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
  <link rel="icon" href="/favicon.ico" />
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold tracking-tight">ü™Å Kite Detector</h1>

      <div class="flex items-center space-x-3">
        <a href="/binary_kite_sensor"
          class="ml-3 px-3 py-2 rounded bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600 transition">
          Binary Sensor
        </a>
        <form id="minutes-form" method="get" class="flex items-center space-x-2">
          <label for="minutes" class="text-sm text-gray-500 dark:text-gray-300 select-none">Live: Last</label>
          <input
            type="number"
            id="minutes"
            name="minutes"
            value="{{ request.query_params.get('minutes', 30) }}"
            min="1"
            max="1440"
            inputmode="numeric"
            pattern="[0-9]*"
            class="w-12 text-center text-sm font-medium cursor-pointer bg-transparent border border-transparent rounded transition
              focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:bg-white/90 dark:focus:bg-gray-700 dark:focus:ring-indigo-600
              text-gray-700 dark:text-gray-200 appearance-none hover:bg-gray-100 dark:hover:bg-gray-600"
            title="Click to edit minutes"
          />
          <span class="text-sm text-gray-500 dark:text-gray-300 select-none">Minutes</span>
        </form>

        <!-- Theme Toggle -->
        <button id="theme-toggle"
          class="p-2 bg-gray-100 dark:bg-gray-900 rounded-full shadow  hover:bg-gray-900 dark:hover:bg-white transition"
          title="Toggle dark/light mode">
          üåô/‚òÄÔ∏è
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Metrics Summary -->
        <section class="mb-10 bg-white dark:bg-gray-700 rounded-lg shadow  p-6">
      <h2 class="text-xl font-semibold mb-4">Metrics Summary</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
        <div><strong>Total Captures:</strong> {{ metrics.total }}</div>
        <div><strong>Kite Detections:</strong> {{ metrics.kite_count }}</div>
        <div><strong>Kite Ratio:</strong> {{ metrics.kite_ratio | round(1) }}%</div>
        <div><strong>Capture Rate:</strong> {{ metrics.capture_rate }} /min</div>
      </div>
    </section>

        <!-- windguru FDT -->
<section class="mb-10 bg-white dark:bg-gray-700 rounded-lg shadow  p-6">
    <script id="wg_fwdg_317_100_1753081197454">
    (function (window, document) {
    var loader = function () {
        var arg = ["s=317" ,"m=100","uid=wg_fwdg_317_100_1753081197454" ,"wj=knots" ,"tj=c" ,"waj=m" ,"tij=cm" ,"odh=12" ,"doh=20" ,"fhours=240" ,"hrsm=2" ,"vt=forecasts" ,"lng=en" ,"idbs=1" ,"p=WINDSPD,GUST,SMER,TMPE,FLHGT,CDC,APCP1s"];
        var script = document.createElement("script");
        var tag = document.getElementsByTagName("script")[0];
        script.src = "https://www.windguru.cz/js/widget.php?"+(arg.join("&"));
        tag.parentNode.insertBefore(script, tag);
    };
    window.addEventListener ? window.addEventListener("load", loader, false) : window.attachEvent("onload", loader);
    })(window, document);
    </script>  
</section>

    <!-- Camera Sections -->
    {% for cam, stats in max_stat_by_folder.items() %}
    <section class="mb-12">
            <h2
                class="text-xl font-semibold bg-gray-100 dark:bg-gray-800 px-2 py-1 sticky top-16 z-20 border-b border-gray-300 shadow-sm">
        üì∑ Camera: {{ cam }}
      </h2>


      <!-- Max Stats Table -->
      <div class="overflow-x-auto mb-4">
        <table class="w-full bg-white dark:bg-gray-700 rounded shadow text-sm">
          <thead class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-100">
            <tr>
              <th class="text-left py-2 px-4">Label</th>
              <th class="text-left py-2 px-4">Max Count</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in stats %}
            <tr class="border-t">
              <td class="py-2 px-4">{{ stat.label }}</td>
              <td class="py-2 px-4">{{ stat.max }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if captures_by_folder[cam] %}
      <!-- Image Slider -->
            <div class="relative group overflow-hidden rounded-xl shadow bg-white dark:bg-gray-800"
                id="slider-{{ cam }}">

        <div class="slider-wrapper flex transition-transform duration-500">
          {% for cap in captures_by_folder[cam] %}
          <div class="slide min-w-full flex flex-col items-center">
            <img src="{{ cap.bbox_url }}" alt="Capture {{ cap.id }}"
              class="object-contain w-full max-h-[500px] rounded-xl shadow-lg transition duration-300 ease-in-out hover:scale-[1.01]">
                        <div
                            class="bg-gray-50 dark:bg-gray-800 w-full text-center text-sm text-gray-600 dark:text-gray-100 py-2 border-t ">
              ‚è±Ô∏è {{ cap.timestamp }}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Arrows -->
        <div class="absolute top-1/2 -translate-y-1/2 left-2 w-10 h-10 rounded-full bg-white/70 hover:bg-white flex items-center justify-center text-xl text-gray-800 shadow cursor-pointer z-10 transition-opacity opacity-0 group-hover:opacity-100"
                    onclick="prevSlide('{{ cam }}')">
                    &#10094;
                </div>
        <div class="absolute top-1/2 -translate-y-1/2 right-2 w-10 h-10 rounded-full bg-white/70 hover:bg-white flex items-center justify-center text-xl text-gray-800 shadow cursor-pointer z-10 transition-opacity opacity-0 group-hover:opacity-100"
                    onclick="nextSlide('{{ cam }}')">
                    &#10095;
                </div>


        <!-- Dots -->
        <div class="dots mt-3 flex justify-center gap-2">

          {% for _ in captures_by_folder[cam] %}
          <div class="dot w-3 h-3 bg-gray-400 rounded-full opacity-60 cursor-pointer transition-all"></div>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <p class="text-sm text-gray-500 italic mt-2">No captures found for this camera.</p>
      {% endif %}
    </section>
    {% endfor %}
  </main>

    <!-- Slider Script -->
  <script>
 const themeToggleBtn = document.getElementById('theme-toggle');
  const root = document.documentElement;

  function setTheme(theme) {
    if (theme === 'dark') {
      root.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      root.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
    updateThemeIcon();
  }

  function loadTheme() {
    const saved = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const useDark = saved === 'dark' || (!saved && systemPrefersDark);
    if (useDark) root.classList.add('dark');
    updateThemeIcon();
  }

  function updateThemeIcon() {
    const isDark = root.classList.contains('dark');
    themeToggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  }

  themeToggleBtn.addEventListener('click', () => {
    const isDark = root.classList.contains('dark');
    setTheme(isDark ? 'light' : 'dark');
  });

  loadTheme();

    // Minutes auto-submit
    document.getElementById("minutes").addEventListener("change", () => {
      document.getElementById("minutes-form").submit();
    });

    // Slider
    const sliderState = {};

    function updateDots(camId) {
      const dots = document.querySelectorAll(`#slider-${camId} .dot`);
      dots.forEach((dot, i) => {
        dot.classList.toggle('bg-gray-800', i === sliderState[camId]);
        dot.classList.toggle('bg-gray-400', i !== sliderState[camId]);
        dot.classList.toggle('opacity-100', i === sliderState[camId]);
        dot.classList.toggle('opacity-60', i !== sliderState[camId]);
      });
    }

    function goToSlide(camId, index) {
      const wrapper = document.querySelector(`#slider-${camId} .slider-wrapper`);
      sliderState[camId] = index;
      wrapper.style.transform = `translateX(-${index * 100}%)`;
      updateDots(camId);
    }

    function nextSlide(camId) {
      const wrapper = document.querySelector(`#slider-${camId} .slider-wrapper`);
      const slides = wrapper.querySelectorAll('.slide');
      sliderState[camId] = (sliderState[camId] + 1) % slides.length;
      wrapper.style.transform = `translateX(-${sliderState[camId] * 100}%)`;
      updateDots(camId);
    }

    function prevSlide(camId) {
      const wrapper = document.querySelector(`#slider-${camId} .slider-wrapper`);
      const slides = wrapper.querySelectorAll('.slide');
      sliderState[camId] = (sliderState[camId] - 1 + slides.length) % slides.length;
      wrapper.style.transform = `translateX(-${sliderState[camId] * 100}%)`;
      updateDots(camId);
    }

    window.onload = () => {
      document.querySelectorAll('[id^="slider-"]').forEach(slider => {
        const camId = slider.id.replace('slider-', '');
        sliderState[camId] = 0;
        updateDots(camId);
      });
    };
  </script>

</body>
</html>
